# 节点重叠问题复现工具

这个目录包含了用于复现和调试节点重叠问题的工具和方法。

## 问题描述

节点重叠问题的根本原因是**节点尺寸计算、布局计算和DOM渲染之间的时序不一致**：

1. **异步渲染导致的状态不一致**：子节点异步渲染可能导致父节点布局计算基于过时的子节点尺寸
2. **布局计算时机问题**：节点位置计算依赖的尺寸信息可能在DOM更新完成前就被使用
3. **DOM更新延迟**：节点尺寸计算时DOM元素可能还未完全渲染完成

## 复现方法

### 方法1：代码层面直接修改

#### 1.1 启用渲染延迟模拟

在 `src/core/render/Render.js` 的 `_render` 方法中，取消注释以下代码：

```javascript
// 【调试用】模拟渲染时序问题，用于复现节点重叠bug
// 取消注释下面的代码可以复现节点重叠问题
if (Math.random() < 0.3) {
  // 随机延迟渲染，模拟DOM更新和布局计算的时序不一致
  setTimeout(() => {
    this._renderInternal();
  }, Math.random() * 20);
  return;
}
```

#### 1.2 启用尺寸计算错误模拟

在 `src/core/render/node/nodeLayout.js` 的 `getNodeRect` 方法中，取消注释以下代码：

```javascript
// 【调试用】模拟DOM尺寸计算错误，用于复现节点重叠bug
// 取消注释下面的代码可以复现节点重叠问题
if (Math.random() < 0.2 && this.children && this.children.length > 0) {
  // 模拟DOM未完全渲染时获取到错误的尺寸
  const originalResult = this._getNodeRectOriginal ? this._getNodeRectOriginal() : null;
  if (originalResult) {
    return {
      width: originalResult.width * (0.7 + Math.random() * 0.2), // 返回70%-90%的宽度
      height: originalResult.height * (0.8 + Math.random() * 0.15) // 返回80%-95%的高度
    };
  }
}
```

### 方法2：使用复现工具

#### 2.1 导入复现工具

```javascript
import { 
  enableNodeOverlapReproduction, 
  disableNodeOverlapReproduction,
  triggerConcurrentRenderingConflict,
  rapidExpandCollapseOperations
} from './src/debug/reproduceNodeOverlap.js';
```

#### 2.2 启用复现模式

```javascript
// 启用复现模式，使用默认配置
enableNodeOverlapReproduction(mindMap);

// 或者使用自定义配置
enableNodeOverlapReproduction(mindMap, {
  renderDelayProbability: 0.5,  // 50%概率触发渲染延迟
  sizeErrorProbability: 0.3,    // 30%概率触发尺寸错误
  maxRenderDelay: 30,           // 最大延迟30ms
  sizeErrorRange: [0.6, 0.8]    // 尺寸错误范围60%-80%
});
```

#### 2.3 手动触发特定场景

```javascript
// 触发并发渲染冲突
triggerConcurrentRenderingConflict(mindMap);

// 快速展开/收起操作
rapidExpandCollapseOperations(mindMap, 10); // 执行10次快速操作
```

#### 2.4 禁用复现模式

```javascript
disableNodeOverlapReproduction();
```

### 方法3：浏览器控制台直接使用

如果复现工具已加载到全局对象，可以直接在浏览器控制台中使用：

```javascript
// 启用复现模式
window.reproduceNodeOverlap.enable(window.mindMap);

// 触发并发渲染冲突
window.reproduceNodeOverlap.triggerConflict(window.mindMap);

// 快速操作
window.reproduceNodeOverlap.rapidOperations(window.mindMap, 5);

// 查看状态
window.reproduceNodeOverlap.getStatus();

// 禁用复现模式
window.reproduceNodeOverlap.disable();
```

## 验证方法

启用任一复现方法后，在思维导图中进行以下操作：

1. **展开包含多个子节点的节点**
2. **展开层级较深的节点**
3. **在画布缩放状态下展开节点**
4. **快速连续展开/收起多个节点**

应该能观察到以下问题现象：
- 节点位置重叠
- 节点布局错乱
- 连接线位置异常
- 文本内容显示异常

## 注意事项

1. **仅用于调试**：这些复现方法仅用于调试和问题分析，不应在生产环境中使用
2. **性能影响**：启用复现模式可能会影响渲染性能
3. **随机性**：由于使用了随机概率，可能需要多次尝试才能复现问题
4. **及时禁用**：调试完成后请及时禁用复现模式或注释相关代码

## 问题分析

当成功复现问题后，可以通过以下方式进行分析：

1. **查看控制台日志**：复现工具会输出详细的触发日志
2. **检查节点状态**：使用浏览器开发者工具检查节点的位置和尺寸属性
3. **断点调试**：在关键渲染方法中设置断点，观察执行顺序
4. **性能分析**：使用浏览器性能工具分析渲染时序

## 解决方案方向

基于问题分析，可能的解决方案包括：

1. **同步化关键渲染步骤**：确保尺寸计算和布局计算的同步执行
2. **增加渲染状态检查**：在布局计算前确保DOM已完全更新
3. **优化异步渲染机制**：改进子节点异步渲染的回调机制
4. **添加渲染队列**：使用队列机制避免并发渲染冲突